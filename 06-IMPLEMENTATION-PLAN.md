# Implementation Plan: Foundry

Generated by: Implementation Orchestrator Agent v30 (Audit-Hardened)
Date: 2026-01-22
Status: Ready for Development

Framework: Agent Specification Framework v2.1
Constitution: Agent 0 - Agent Constitution v3.3

---

## 1. Implementation Overview

### 1.1 Project Summary

Foundry is a multi-tenant data preparation platform deployed on Replit. The implementation follows a monolithic full-stack architecture with React frontend (Vite + TypeScript + shadcn/ui) and Express.js backend (Node.js + TypeScript + Drizzle ORM) connected to PostgreSQL (Neon).

**Key Statistics:**
- **Total Endpoints:** 57 API endpoints
- **Total Pages:** 15 UI pages
- **Total Entities:** 12 database tables
- **Total User Stories:** 32 stories across 10 features
- **Deployment:** Replit (single container, port 5000)

### 1.2 Technology Stack

**Frontend:**
- React 18.x with TypeScript 5.x
- Vite 5.x (build tool)
- Tailwind CSS 3.x + shadcn/ui
- React Query 5.x (server state)
- React Hook Form 7.x + Zod 3.x (forms/validation)
- React Router 6.x

**Backend:**
- Node.js 20.x LTS with TypeScript 5.x
- Express.js 4.x
- Drizzle ORM with postgres-js
- PostgreSQL (Neon) via Replit
- bcrypt (password hashing)
- JWT (authentication)

**Security:**
- helmet (security headers)
- cors (CORS handling)
- express-rate-limit (rate limiting)
- AES-256-GCM (API key encryption)

### 1.3 Development Approach

This implementation plan uses **incremental development with complete scaffolding**:

1. **SETUP Phase:** Project structure, dependencies, configuration files
2. **DATA Phase:** Database schema, migrations, seed data
3. **API Phase:** Backend routes and services (57 endpoints)
4. **UI Phase:** Frontend pages and components (15 pages)
5. **COMP Phase:** Shared components and utilities
6. **INTEG Phase:** Integration testing and final verification

**Code Generation Strategy:**
- **FULL CODE:** 6 mandatory utility files (prevent production bugs)
- **SKELETON CODE:** All other files (types + signatures + TODOs)
- **NO CODE:** Standard shadcn/ui components (install via CLI)

---

## 2. Project Scaffolding

### 2.1 Directory Structure

```
foundry/
├── client/                          # React frontend
│   ├── public/                      # Static assets
│   ├── src/
│   │   ├── components/
│   │   │   ├── ui/                 # shadcn/ui components (generated)
│   │   │   ├── auth/               # Auth-specific components
│   │   │   ├── projects/           # Project-specific components
│   │   │   ├── sources/            # Source-specific components
│   │   │   ├── processing/         # Processing-specific components
│   │   │   ├── datasets/           # Dataset-specific components
│   │   │   ├── layout/             # Layout components (Header, Sidebar)
│   │   │   └── error-boundary.tsx  # MANDATORY: React error boundary
│   │   ├── pages/                  # Page components (15 total)
│   │   │   ├── auth/               # Login, Register, ForgotPassword, ResetPassword
│   │   │   ├── projects/           # Dashboard, ProjectsPage, ProjectDetailPage
│   │   │   ├── sources/            # SourceDetailPage, CreateTeamworkSourcePage
│   │   │   ├── processing/         # RunDetailPage
│   │   │   ├── datasets/           # DatasetDetailPage
│   │   │   ├── settings/           # OrganizationSettingsPage, TeamPage, ProfilePage
│   │   │   ├── audit/              # AuditLogsPage
│   │   │   └── NotFoundPage.tsx
│   │   ├── hooks/                  # Custom React hooks
│   │   │   ├── useAuth.ts          # Authentication hook
│   │   │   ├── useProjects.ts      # Projects data hook
│   │   │   └── useRunStatus.ts     # Run polling hook
│   │   ├── lib/
│   │   │   ├── api.ts              # API client setup (axios)
│   │   │   ├── utils.ts            # cn() utility
│   │   │   └── queryClient.ts      # React Query client
│   │   ├── types/                  # TypeScript types (shared with backend)
│   │   ├── App.tsx                 # Root component with routing
│   │   ├── index.css               # Tailwind imports + CSS variables
│   │   └── main.tsx                # Application entry point
│   ├── index.html
│   ├── vite.config.ts
│   ├── tailwind.config.js
│   ├── postcss.config.js
│   ├── tsconfig.json
│   └── package.json
│
├── server/                          # Express backend
│   ├── db/
│   │   ├── schema.ts               # Drizzle schema definitions
│   │   ├── index.ts                # MANDATORY: Database connection
│   │   ├── migrations/             # Database migration files
│   │   └── seed.ts                 # Seed data script
│   ├── routes/                     # API route handlers
│   │   ├── auth.routes.ts          # 11 auth endpoints
│   │   ├── organizations.routes.ts # 3 organization endpoints
│   │   ├── invitations.routes.ts   # 4 invitation endpoints
│   │   ├── projects.routes.ts      # 5 project endpoints
│   │   ├── sources.routes.ts       # 12 source endpoints
│   │   ├── processing.routes.ts    # 6 processing endpoints
│   │   ├── runs.routes.ts          # 6 run endpoints
│   │   ├── datasets.routes.ts      # 8 dataset endpoints
│   │   ├── audit.routes.ts         # 2 audit endpoints
│   │   ├── users.routes.ts         # 3 user endpoints
│   │   └── health.routes.ts        # 1 health check endpoint
│   ├── services/                   # Business logic
│   │   ├── auth.service.ts         # Authentication logic
│   │   ├── organizations.service.ts
│   │   ├── projects.service.ts
│   │   ├── sources.service.ts
│   │   ├── schema.service.ts
│   │   ├── pii.service.ts
│   │   ├── processing.service.ts
│   │   ├── export.service.ts
│   │   └── teamwork.service.ts     # Teamwork Desk API integration
│   ├── middleware/
│   │   ├── auth.middleware.ts      # JWT validation
│   │   ├── role.middleware.ts      # RBAC checks
│   │   ├── validation.middleware.ts # Zod schema validation
│   │   ├── org-scope.middleware.ts # Multi-tenant data scoping
│   │   ├── rate-limit.middleware.ts # Rate limiting
│   │   ├── request-id.middleware.ts # Request ID generation (Pattern 26)
│   │   └── error-handler.ts        # MANDATORY: Global error handler
│   ├── lib/
│   │   ├── validation.ts           # MANDATORY: parseIntParam, parsePaginationParams
│   │   ├── response.ts             # MANDATORY: sendSuccess, sendError helpers
│   │   ├── tokens.ts               # JWT generation/verification
│   │   ├── password.ts             # bcrypt hashing/verification
│   │   ├── encryption.ts           # AES-256-GCM for API keys
│   │   ├── file-parser.ts          # CSV/XLSX/JSON parsing
│   │   └── config.ts               # Configuration constants (Pattern 27)
│   ├── errors/
│   │   └── index.ts                # MANDATORY: AppError classes
│   ├── utils/
│   │   ├── audit-log.ts            # Audit logging helper
│   │   └── pii-patterns.ts         # PII detection regex patterns
│   ├── types/                      # TypeScript types
│   │   ├── express.d.ts            # Express type extensions
│   │   └── models.ts               # Data model types
│   ├── index.ts                    # Server entry point
│   ├── tsconfig.json
│   └── package.json
│
├── shared/                          # Shared types/schemas
│   └── types/
│       └── api.types.ts            # Request/response types
│
├── docs/                            # Documentation
│   ├── 01-PRD.md
│   ├── 02-ARCHITECTURE.md
│   ├── 03-DATA-MODEL.md
│   ├── 04-API-CONTRACT.md
│   ├── 05-UI-SPECIFICATION.md
│   └── 06-IMPLEMENTATION-PLAN.md   # This document
│
├── .env.example                     # Environment variables template
├── .replit                          # Replit configuration
├── replit.nix                       # Nix configuration
├── .gitignore
├── package.json                     # Root package.json (workspaces)
└── README.md
```

### 2.2 Configuration Files

#### 2.2.1 Root package.json

```json
{
  "name": "foundry",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "client",
    "server"
  ],
  "scripts": {
    "dev": "concurrently \"npm run dev:server\" \"npm run dev:client\"",
    "dev:server": "cd server && npm run dev",
    "dev:client": "cd client && npm run dev",
    "build": "npm run build:client && npm run build:server",
    "build:client": "cd client && npm run build",
    "build:server": "cd server && npm run build",
    "db:push": "cd server && npm run db:push",
    "db:migrate": "cd server && npm run db:migrate",
    "db:seed": "cd server && npm run db:seed",
    "lint": "eslint . --ext .ts,.tsx",
    "type-check": "tsc --noEmit"
  },
  "devDependencies": {
    "concurrently": "^8.2.2",
    "typescript": "^5.3.3"
  },
  "comment": "Known Good Versions - Pin major versions for stability"
}
```

#### 2.2.2 .replit

```toml
run = "npm run dev"
entrypoint = "server/index.ts"
hidden = [".config", "package-lock.json"]

[nix]
channel = "stable-23_11"

[deployment]
run = ["sh", "-c", "npm run build && npm run dev:server"]
deploymentTarget = "cloudrun"
ignorePorts = false

[env]
PATH = "/home/runner/$REPL_SLUG/.config/npm/node_global/bin:/home/runner/$REPL_SLUG/node_modules/.bin"
npm_config_prefix = "/home/runner/$REPL_SLUG/.config/npm/node_global"
```

#### 2.2.3 .env.example

```bash
# Database (Required - Replit provides via Secrets)
DATABASE_URL=postgresql://user:password@host:port/database

# JWT (Required - Generate with: openssl rand -hex 32)
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=1h
JWT_REFRESH_SECRET=your-refresh-secret-here
JWT_REFRESH_EXPIRES_IN=7d

# Server (Required)
NODE_ENV=development
PORT=5000

# Encryption (Required for API keys - Generate with: openssl rand -hex 32)
ENCRYPTION_KEY=your-encryption-key-here

# CORS (Optional - defaults to all origins in development)
CORS_ORIGIN=http://localhost:5173

# Rate Limiting (Optional - defaults shown)
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# File Upload (Optional - defaults shown)
MAX_FILE_SIZE_MB=100
UPLOAD_DIR=./uploads

# Teamwork Desk (Optional - only needed if using Teamwork integration)
# TEAMWORK_API_URL=https://api.teamwork.com

# Email (Optional - only needed for password reset emails)
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USER=your-email@gmail.com
# SMTP_PASS=your-app-password
# FROM_EMAIL=noreply@foundry.app
```

**Environment Variable Classification:**
- **REQUIRED (app crashes on startup if missing):** DATABASE_URL, JWT_SECRET, ENCRYPTION_KEY
- **OPTIONAL (graceful degradation):** TEAMWORK_API_URL, SMTP_*, CORS_ORIGIN

#### 2.2.4 server/package.json

```json
{
  "name": "foundry-server",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "tsx watch --clear-screen=false src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "db:push": "drizzle-kit push --force",
    "db:migrate": "drizzle-kit migrate",
    "db:generate": "drizzle-kit generate",
    "db:seed": "tsx src/db/seed.ts"
  },
  "dependencies": {
    "express": "^4.21.0",
    "postgres": "^3.4.4",
    "drizzle-orm": "^0.33.0",
    "bcrypt": "^5.1.1",
    "jsonwebtoken": "^9.0.2",
    "zod": "^3.23.8",
    "helmet": "^7.1.0",
    "cors": "^2.8.5",
    "express-rate-limit": "^7.4.0",
    "multer": "^1.4.5-lts.1",
    "date-fns": "^3.6.0",
    "dotenv": "^16.4.5",
    "nanoid": "^5.0.7",
    "axios": "^1.7.7"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/node": "^20.16.5",
    "@types/bcrypt": "^5.0.2",
    "@types/jsonwebtoken": "^9.0.7",
    "@types/cors": "^2.8.17",
    "@types/multer": "^1.4.12",
    "tsx": "^4.19.1",
    "typescript": "^5.3.3",
    "drizzle-kit": "^0.24.0"
  },
  "comment": "Known Good Versions - Pin major versions for stability"
}
```

#### 2.2.5 client/package.json

```json
{
  "name": "foundry-client",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite --port 5173",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.26.2",
    "@tanstack/react-query": "^5.56.2",
    "react-hook-form": "^7.53.0",
    "zod": "^3.23.8",
    "@hookform/resolvers": "^3.9.0",
    "axios": "^1.7.7",
    "date-fns": "^3.6.0",
    "lucide-react": "^0.447.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "tailwind-merge": "^2.5.2",
    "@radix-ui/react-alert-dialog": "^1.1.1",
    "@radix-ui/react-dialog": "^1.1.1",
    "@radix-ui/react-dropdown-menu": "^2.1.1",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-select": "^2.1.1",
    "@radix-ui/react-separator": "^1.1.0",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-switch": "^1.1.0",
    "@radix-ui/react-tabs": "^1.1.0",
    "@radix-ui/react-toast": "^1.2.1"
  },
  "devDependencies": {
    "@types/react": "^18.3.5",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "typescript": "^5.3.3",
    "vite": "^5.4.6",
    "tailwindcss": "^3.4.11",
    "postcss": "^8.4.47",
    "autoprefixer": "^10.4.20",
    "eslint": "^8.57.1",
    "@typescript-eslint/eslint-plugin": "^6.21.0",
    "@typescript-eslint/parser": "^6.21.0"
  },
  "comment": "Known Good Versions - Pin major versions for stability"
}
```

#### 2.2.6 client/vite.config.ts

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true,
      },
    },
    watch: {
      usePolling: true,
      ignored: ['**/node_modules/**', '**/.git/**', '**/dist/**']
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true,
  },
});
```

**CRITICAL:** `watch.ignored` configuration is required for Replit to prevent file watching issues.

#### 2.2.7 client/tailwind.config.js

```javascript
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: ["class"],
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
}
```

#### 2.2.8 client/src/index.css

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* CSS import syntax must match Tailwind version */
/* Tailwind v3.x uses: @tailwind directives */
/* Tailwind v4.x uses: @import "tailwindcss"; */

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    --primary: 210 40% 98%;
    --primary-foreground: 222.2 47.4% 11.2%;
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    --accent: 217.2 32.6% 17.5%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 212.7 26.8% 83.9%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}
```

#### 2.2.9 server/drizzle.config.ts

```typescript
import type { Config } from 'drizzle-kit';
import 'dotenv/config';

export default {
  schema: './src/db/schema.ts',
  out: './src/db/migrations',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

---

## 3. MANDATORY Files (Full Code Required)

These 6 files MUST be generated with complete, production-ready code to prevent common bugs:

### 3.1 server/lib/validation.ts

**Purpose:** Prevent NaN database errors from parseInt usage in 38+ routes

```typescript
import { BadRequestError } from '../errors/index.js';

/**
 * Parse integer URL parameter with validation
 * Throws BadRequestError if invalid
 * 
 * @example
 * const projectId = parseIntParam(req.params.projectId, 'projectId');
 */
export function parseIntParam(value: string, paramName: string): number {
  const parsed = parseInt(value, 10);
  
  if (isNaN(parsed) || parsed <= 0) {
    throw new BadRequestError(`Invalid ${paramName}: must be a positive integer`);
  }
  
  return parsed;
}

/**
 * Parse pagination query parameters
 * Returns validated page and limit with defaults
 * 
 * @example
 * const { page, limit, offset } = parsePaginationParams(req.query);
 */
export function parsePaginationParams(query: any): {
  page: number;
  limit: number;
  offset: number;
} {
  const page = query.page ? parseInt(query.page as string, 10) : 1;
  const limit = query.limit ? parseInt(query.limit as string, 10) : 20;
  
  if (isNaN(page) || page < 1) {
    throw new BadRequestError('Invalid page: must be a positive integer');
  }
  
  if (isNaN(limit) || limit < 1 || limit > 100) {
    throw new BadRequestError('Invalid limit: must be between 1 and 100');
  }
  
  const offset = (page - 1) * limit;
  
  return { page, limit, offset };
}

/**
 * Parse optional query integer with validation
 * Returns null if not provided or invalid
 */
export function parseQueryInt(value: any): number | null {
  if (value === undefined || value === null || value === '') {
    return null;
  }
  
  const parsed = parseInt(value as string, 10);
  return isNaN(parsed) ? null : parsed;
}
```

### 3.2 server/lib/response.ts

**Purpose:** Consistent API response envelope preventing frontend parsing errors

```typescript
import { Response } from 'express';

/**
 * Send successful response with data
 */
export function sendSuccess<T>(res: Response, data: T, statusCode: number = 200): Response {
  return res.status(statusCode).json({
    data,
  });
}

/**
 * Send created response (201)
 */
export function sendCreated<T>(res: Response, data: T): Response {
  return sendSuccess(res, data, 201);
}

/**
 * Send paginated response with meta
 */
export function sendPaginated<T>(
  res: Response,
  data: T[],
  meta: {
    page: number;
    pageSize: number;
    totalPages: number;
    totalCount: number;
  }
): Response {
  return res.status(200).json({
    data,
    meta: {
      pagination: {
        ...meta,
        hasNextPage: meta.page < meta.totalPages,
      },
    },
  });
}

/**
 * Send error response
 * Should only be used by error handler middleware
 */
export function sendError(
  res: Response,
  error: {
    code: string;
    message: string;
    statusCode: number;
    details?: any;
  },
  requestId?: string
): Response {
  return res.status(error.statusCode).json({
    error: {
      code: error.code,
      message: error.message,
      ...(error.details && { details: error.details }),
    },
    meta: {
      timestamp: new Date().toISOString(),
      ...(requestId && { requestId }),
    },
  });
}
```

### 3.3 server/errors/index.ts

**Purpose:** Proper error hierarchy preventing 500s instead of 4xxs

```typescript
/**
 * Base application error class
 * All custom errors extend this
 */
export class AppError extends Error {
  constructor(
    public statusCode: number,
    public code: string,
    message: string,
    public details?: any
  ) {
    super(message);
    this.name = this.constructor.name;
    Error.captureStackTrace(this, this.constructor);
  }
}

/**
 * 400 Bad Request errors
 * Use for: invalid input, validation failures
 */
export class BadRequestError extends AppError {
  constructor(message: string = 'Bad request', details?: any) {
    super(400, 'BAD_REQUEST', message, details);
  }
}

/**
 * 401 Unauthorized errors
 * Use for: missing/invalid authentication
 */
export class UnauthorizedError extends AppError {
  constructor(message: string = 'Unauthorized') {
    super(401, 'UNAUTHORIZED', message);
  }
}

/**
 * 403 Forbidden errors
 * Use for: authenticated but insufficient permissions
 */
export class ForbiddenError extends AppError {
  constructor(message: string = 'Forbidden') {
    super(403, 'FORBIDDEN', message);
  }
}

/**
 * 404 Not Found errors
 * Use for: resource doesn't exist
 */
export class NotFoundError extends AppError {
  constructor(resource: string = 'Resource') {
    super(404, 'NOT_FOUND', `${resource} not found`);
  }
}

/**
 * 409 Conflict errors
 * Use for: duplicate resources, concurrent updates
 */
export class ConflictError extends AppError {
  constructor(message: string = 'Conflict') {
    super(409, 'CONFLICT', message);
  }
}

/**
 * 422 Unprocessable Entity errors
 * Use for: semantic validation failures
 */
export class ValidationError extends AppError {
  constructor(message: string = 'Validation failed', details?: any) {
    super(422, 'VALIDATION_ERROR', message, details);
  }
}

/**
 * 429 Too Many Requests errors
 * Use for: rate limiting
 */
export class RateLimitError extends AppError {
  constructor(message: string = 'Too many requests') {
    super(429, 'RATE_LIMIT_EXCEEDED', message);
  }
}

/**
 * 500 Internal Server Error
 * Use for: unexpected errors
 */
export class InternalServerError extends AppError {
  constructor(message: string = 'Internal server error') {
    super(500, 'INTERNAL_ERROR', message);
  }
}

/**
 * 503 Service Unavailable errors
 * Use for: external service failures
 */
export class ServiceUnavailableError extends AppError {
  constructor(service: string = 'Service') {
    super(503, 'SERVICE_UNAVAILABLE', `${service} is currently unavailable`);
  }
}
```

### 3.4 server/middleware/error-handler.ts

**Purpose:** Global error handler preventing unhandled exceptions crashing server

```typescript
import { Request, Response, NextFunction } from 'express';
import { AppError } from '../errors/index.js';
import { sendError } from '../lib/response.js';
import { ZodError } from 'zod';

/**
 * Global error handler middleware
 * Catches all errors and formats consistent responses
 * MUST be registered last in middleware chain
 */
export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
): void {
  // Log error for debugging
  console.error('Error:', {
    name: err.name,
    message: err.message,
    stack: process.env.NODE_ENV === 'development' ? err.stack : undefined,
  });

  // Extract request ID if present
  const requestId = (req as any).id;

  // Handle Zod validation errors
  if (err instanceof ZodError) {
    sendError(
      res,
      {
        code: 'VALIDATION_ERROR',
        message: 'Validation failed',
        statusCode: 422,
        details: err.errors.map(e => ({
          field: e.path.join('.'),
          message: e.message,
        })),
      },
      requestId
    );
    return;
  }

  // Handle custom AppErrors
  if (err instanceof AppError) {
    sendError(
      res,
      {
        code: err.code,
        message: err.message,
        statusCode: err.statusCode,
        details: err.details,
      },
      requestId
    );
    return;
  }

  // Handle unknown errors as 500
  sendError(
    res,
    {
      code: 'INTERNAL_ERROR',
      message: process.env.NODE_ENV === 'development' 
        ? err.message 
        : 'An unexpected error occurred',
      statusCode: 500,
    },
    requestId
  );
}

/**
 * Async handler wrapper
 * Catches promise rejections and passes to error handler
 * 
 * @example
 * router.get('/projects', asyncHandler(async (req, res) => {
 *   const projects = await projectService.findAll();
 *   sendSuccess(res, projects);
 * }));
 */
export function asyncHandler(
  fn: (req: Request, res: Response, next: NextFunction) => Promise<any>
) {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
}
```

### 3.5 client/src/components/error-boundary.tsx

**Purpose:** React error boundary preventing blank white screen on unhandled errors

```typescript
import React, { Component, ErrorInfo, ReactNode } from 'react';
import { Button } from './ui/button';
import { Card } from './ui/card';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

/**
 * Error boundary component
 * Catches React rendering errors and displays fallback UI
 * 
 * @see https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary
 */
export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = {
      hasError: false,
      error: null,
    };
  }

  static getDerivedStateFromError(error: Error): State {
    return {
      hasError: true,
      error,
    };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {
    console.error('ErrorBoundary caught error:', {
      error,
      errorInfo,
      componentStack: errorInfo.componentStack,
    });
  }

  handleReset = (): void => {
    this.setState({
      hasError: false,
      error: null,
    });
    window.location.href = '/';
  };

  render(): ReactNode {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-background p-4">
          <Card className="max-w-md w-full p-6">
            <div className="space-y-4">
              <div>
                <h2 className="text-2xl font-bold text-destructive">
                  Something went wrong
                </h2>
                <p className="text-sm text-muted-foreground mt-2">
                  An unexpected error occurred. Please try refreshing the page.
                </p>
              </div>

              {process.env.NODE_ENV === 'development' && this.state.error && (
                <div className="bg-destructive/10 border border-destructive/20 rounded p-3">
                  <p className="text-xs font-mono text-destructive">
                    {this.state.error.message}
                  </p>
                </div>
              )}

              <div className="flex gap-2">
                <Button onClick={this.handleReset} className="flex-1">
                  Go to Dashboard
                </Button>
                <Button
                  variant="outline"
                  onClick={() => window.location.reload()}
                  className="flex-1"
                >
                  Refresh Page
                </Button>
              </div>
            </div>
          </Card>
        </div>
      );
    }

    return this.props.children;
  }
}
```

### 3.6 server/db/index.ts

**Purpose:** Database connection with postgres-js (correct driver for Replit)

```typescript
import postgres from 'postgres';
import { drizzle } from 'drizzle-orm/postgres-js';
import * as schema from './schema.js';
import 'dotenv/config';

if (!process.env.DATABASE_URL) {
  throw new Error(
    'DATABASE_URL environment variable is required. ' +
    'Add it to your .env file or Replit Secrets.'
  );
}

/**
 * PostgreSQL connection using postgres-js
 * 
 * CRITICAL: Must use postgres-js driver (not node-postgres) per Constitution Section D
 * Replit compatibility requires this specific driver
 */
const queryClient = postgres(process.env.DATABASE_URL, {
  max: 10,
  idle_timeout: 20,
  connect_timeout: 10,
});

/**
 * Drizzle ORM instance
 * Provides type-safe database operations
 */
export const db = drizzle(queryClient, { schema });

/**
 * Close database connection
 * Should be called on graceful shutdown
 */
export async function closeDatabase(): Promise<void> {
  await queryClient.end();
}
```

---

## 4. Ordered Task List

### Task Format

Each task follows this structure:
- **Task ID:** Unique identifier (PHASE-CATEGORY-NUMBER)
- **Title:** Brief description
- **Dependencies:** Tasks that must be completed first
- **Estimated Time:** 1-4 hours per task
- **Acceptance Criteria:** Testable requirements
- **Files:** Files to create/modify

### Phase 1: SETUP (Foundation)

#### SETUP-001: Initialize Project Structure
**Dependencies:** None
**Time:** 2 hours
**Description:** Create root directory structure and initialize npm workspaces

**Tasks:**
1. Create root directory with client/, server/, docs/, shared/ subdirectories
2. Initialize root package.json with workspaces configuration
3. Create .gitignore file (ignore node_modules, .env, dist, uploads)
4. Create README.md with project overview and setup instructions
5. Create .env.example with all required and optional environment variables

**Acceptance Criteria:**
- [ ] Directory structure matches Section 2.1 exactly
- [ ] `npm install` runs successfully in root
- [ ] Workspaces configured correctly

**Files:**
- `/package.json`
- `/.gitignore`
- `/README.md`
- `/.env.example`

---

#### SETUP-002: Configure Replit Environment
**Dependencies:** SETUP-001
**Time:** 1 hour
**Description:** Set up Replit configuration files for deployment

**Tasks:**
1. Create .replit file with run command pointing to port 5000
2. Create replit.nix file with Node.js 20 and PostgreSQL
3. Verify Replit Secrets for DATABASE_URL

**Acceptance Criteria:**
- [ ] .replit file has `run = "npm run dev"`
- [ ] Port 5000 configured
- [ ] Nix channel set to stable-23_11

**Files:**
- `/.replit`
- `/replit.nix`

---

#### SETUP-003: Initialize Backend Package
**Dependencies:** SETUP-001
**Time:** 2 hours
**Description:** Set up Express.js backend with TypeScript

**Tasks:**
1. Initialize server/package.json with dependencies from Section 2.2.4
2. Create server/tsconfig.json with strict mode and ES modules
3. Install dependencies: `npm install` in server/
4. Create server/src/index.ts with Express app skeleton
5. Verify server starts on port 5000

**Acceptance Criteria:**
- [ ] All dependencies installed (run `npm list` to verify)
- [ ] TypeScript compiles without errors
- [ ] Server starts and responds on http://localhost:5000
- [ ] Health check endpoint returns 200 OK

**Files:**
- `/server/package.json`
- `/server/tsconfig.json`
- `/server/src/index.ts`

**Skeleton Template (server/src/index.ts):**
```typescript
// TODO: Implement per SETUP-003
// - Import express, helmet, cors, rate-limit
// - Configure middleware chain
// - Register route handlers
// - Start server on PORT (default 5000)
// - Add graceful shutdown handler
```

---

#### SETUP-004: Initialize Frontend Package
**Dependencies:** SETUP-001
**Time:** 2 hours
**Description:** Set up React frontend with Vite and TypeScript

**Tasks:**
1. Initialize client/package.json with dependencies from Section 2.2.5
2. Create client/tsconfig.json
3. Create client/vite.config.ts with proxy to backend (Section 2.2.6)
4. Create client/tailwind.config.js (Section 2.2.7)
5. Create client/postcss.config.js
6. Install dependencies: `npm install` in client/
7. **CRITICAL:** Verify Tailwind CSS version matches syntax in index.css

**Acceptance Criteria:**
- [ ] All dependencies installed
- [ ] Vite dev server starts on port 5173
- [ ] Proxy to http://localhost:5000/api works
- [ ] CSS syntax matches Tailwind version (v3.x uses @tailwind directives)
- [ ] `watch.ignored` configured in vite.config.ts

**Files:**
- `/client/package.json`
- `/client/tsconfig.json`
- `/client/vite.config.ts`
- `/client/tailwind.config.js`
- `/client/postcss.config.js`

---

#### SETUP-005: Initialize shadcn/ui Components
**Dependencies:** SETUP-004
**Time:** 1 hour
**Description:** Install shadcn/ui and required peer dependencies

**Tasks:**
1. Run `npx shadcn-ui@0.8.0 init` (select defaults)
2. Install all required components:
   ```bash
   npx shadcn-ui@0.8.0 add button card input label select textarea dialog alert toast dropdown-menu table badge separator skeleton tabs form checkbox radio-group switch
   ```
3. Install peer dependencies (Section 1.1 of UI spec)
4. Create client/src/lib/utils.ts with cn() function (Section 3.1)
5. Create client/src/index.css with CSS variables (Section 2.2.8)

**Acceptance Criteria:**
- [ ] All shadcn/ui components installed in client/src/components/ui/
- [ ] cn() utility function works
- [ ] CSS variables defined for light and dark modes
- [ ] No TypeScript errors in components/ui/

**Files:**
- `/client/src/lib/utils.ts` (FULL CODE per Section 3.1)
- `/client/src/index.css` (FULL CODE per Section 2.2.8)
- `/client/src/components/ui/*` (generated by shadcn CLI)

---

#### SETUP-006: Create MANDATORY Utility Files
**Dependencies:** SETUP-003
**Time:** 1 hour
**Description:** Create the 6 mandatory files with full code

**Tasks:**
1. Copy Section 3.1 code to server/lib/validation.ts
2. Copy Section 3.2 code to server/lib/response.ts
3. Copy Section 3.3 code to server/errors/index.ts
4. Copy Section 3.4 code to server/middleware/error-handler.ts
5. Copy Section 3.5 code to client/src/components/error-boundary.tsx
6. Copy Section 3.6 code to server/db/index.ts
7. Register error handler in server/src/index.ts (LAST middleware)

**Acceptance Criteria:**
- [ ] All 6 files created with exact code from Section 3
- [ ] No TypeScript errors
- [ ] Error handler registered in Express app
- [ ] parseIntParam throws BadRequestError for invalid input
- [ ] sendSuccess formats response correctly

**Files:**
- `/server/lib/validation.ts` ✓ MANDATORY
- `/server/lib/response.ts` ✓ MANDATORY
- `/server/errors/index.ts` ✓ MANDATORY
- `/server/middleware/error-handler.ts` ✓ MANDATORY
- `/client/src/components/error-boundary.tsx` ✓ MANDATORY
- `/server/db/index.ts` ✓ MANDATORY

---

### Phase 2: DATA (Database Layer)

#### DATA-001: Create Database Schema
**Dependencies:** SETUP-006
**Time:** 3 hours
**Description:** Implement complete Drizzle schema with all 12 tables

**Tasks:**
1. Create server/db/schema.ts with all entity definitions from Data Model doc
2. Include all audit columns (createdAt, updatedAt)
3. Add foreign key constraints with cascade rules
4. Add indexes for performance (organization_id, email, status fields)
5. Add unique constraints where required
6. Create drizzle.config.ts (Section 2.2.9)

**Acceptance Criteria:**
- [ ] All 12 tables defined: organizations, users, invitations, password_resets, projects, sources, schema_mappings, deidentification_configs, processing_configs, processing_runs, datasets, audit_logs
- [ ] All foreign keys have onDelete cascade/restrict as specified
- [ ] All indexes created per Data Model
- [ ] TypeScript types generated correctly
- [ ] No validation errors from Drizzle

**Files:**
- `/server/db/schema.ts`
- `/server/drizzle.config.ts`

**Skeleton Template:**
```typescript
// server/db/schema.ts
import { pgTable, serial, text, timestamp, integer, boolean, jsonb, index, uniqueIndex } from 'drizzle-orm/pg-core';

// TODO: Implement per DATA-001
// @see Data Model Section 2
// - Define auditColumns helper
// - Create organizations table
// - Create users table with role enum
// - Create invitations table with token
// - Create password_resets table
// - Create projects table with soft delete
// - Create sources table with type enum
// - Create schema_mappings table with JSONB
// - Create deidentification_configs table
// - Create processing_configs table
// - Create processing_runs table with status enum
// - Create datasets table with JSONB output
// - Create audit_logs table
```

---

#### DATA-002: Generate and Run Database Migrations
**Dependencies:** DATA-001
**Time:** 1 hour
**Description:** Create migration files and apply to database

**Tasks:**
1. Run `npm run db:generate` to create migration SQL
2. Review generated migration file
3. Run `npm run db:push --force` to apply schema (Replit requires --force)
4. Verify all tables created in database
5. Test database connection from server

**Acceptance Criteria:**
- [ ] Migration file generated in server/db/migrations/
- [ ] Migration applied successfully with --force flag
- [ ] All 12 tables exist in database
- [ ] Foreign keys and indexes created
- [ ] Connection test passes

**Commands:**
```bash
cd server
npm run db:generate
npm run db:push --force
```

---

#### DATA-003: Create Seed Data Script
**Dependencies:** DATA-002
**Time:** 2 hours
**Description:** Populate database with test data for development

**Tasks:**
1. Create server/db/seed.ts script
2. Add seed data for:
   - 1 organization ("Acme Corp")
   - 2 users (admin@acme.com as admin, user@acme.com as member)
   - 1 active invitation
   - 2 projects
   - 3 sources (1 file, 1 Teamwork, 1 with cached data)
   - Sample schema mappings and deidentification configs
3. Hash passwords with bcrypt
4. Generate valid JWT tokens for testing
5. Add npm script: `"db:seed": "tsx src/db/seed.ts"`

**Acceptance Criteria:**
- [ ] Seed script runs without errors
- [ ] Can login with seeded credentials
- [ ] Seeded projects appear in database
- [ ] Foreign key relationships intact
- [ ] Idempotent (can run multiple times safely)

**Files:**
- `/server/db/seed.ts`

**Skeleton Template:**
```typescript
// server/db/seed.ts
import { db } from './index.js';
import { organizations, users, projects, sources } from './schema.js';
import bcrypt from 'bcrypt';

// TODO: Implement per DATA-003
// @see PRD Section 4 for sample data
// - Clear existing data
// - Insert organization
// - Insert users with hashed passwords
// - Insert projects
// - Insert sources with sample data
// - Insert invitations
// - Log success message
```

---

### Phase 3: API (Backend Endpoints)

**Strategy:** Implement all 57 API endpoints grouped by resource. Each task implements one route file with all endpoints for that resource.

#### API-AUTH-001: Health Check Endpoint
**Dependencies:** SETUP-006
**Time:** 30 minutes
**Description:** Implement health check for monitoring

**Route:** GET /api/health
**Authentication:** No
**Frontend Caller:** App initialization

**Tasks:**
1. Create server/routes/health.routes.ts
2. Implement GET /api/health returning { status: 'ok', timestamp }
3. Register route in server/src/index.ts

**Acceptance Criteria:**
- [ ] GET /api/health returns 200 with JSON body
- [ ] Response includes status and timestamp
- [ ] No authentication required
- [ ] Route registered before auth middleware

**Files:**
- `/server/routes/health.routes.ts`

**Skeleton Template:**
```typescript
// server/routes/health.routes.ts
import { Router } from 'express';
import { sendSuccess } from '../lib/response.js';

export const healthRouter = Router();

// GET /api/health - Health check
// @see API Contract endpoint #1
healthRouter.get('/health', (req, res) => {
  // TODO: Implement per API-AUTH-001
  // - Return { status: 'ok', timestamp: ISO string }
  // - Always returns 200 OK
});
```

---

#### API-AUTH-002: Authentication Middleware
**Dependencies:** SETUP-006, DATA-002
**Time:** 2 hours
**Description:** Create JWT authentication middleware

**Tasks:**
1. Create server/lib/tokens.ts with generateToken, verifyToken functions
2. Create server/middleware/auth.middleware.ts with requireAuth
3. Implement token verification with JWT_SECRET
4. Attach user context to req.user
5. Throw UnauthorizedError for invalid/missing tokens

**Acceptance Criteria:**
- [ ] requireAuth middleware validates JWT Bearer tokens
- [ ] Valid tokens attach { id, organizationId, role } to req.user
- [ ] Invalid tokens return 401 UNAUTHORIZED
- [ ] Missing tokens return 401 UNAUTHORIZED
- [ ] Expired tokens return 401 UNAUTHORIZED

**Files:**
- `/server/lib/tokens.ts`
- `/server/middleware/auth.middleware.ts`
- `/server/types/express.d.ts` (extend Request interface)

**Skeleton Template (tokens.ts):**
```typescript
// server/lib/tokens.ts
import jwt from 'jsonwebtoken';
import { UnauthorizedError } from '../errors/index.js';

interface TokenPayload {
  userId: number;
  organizationId: number;
  role: 'admin' | 'member';
}

// TODO: Implement per API-AUTH-002
// @see Architecture Section 7.1, API Contract Section 2.1
// - generateToken(payload): Sign JWT with JWT_SECRET, 1h expiry
// - verifyToken(token): Verify and decode JWT, throw UnauthorizedError if invalid
// - generateRefreshToken(payload): Sign with JWT_REFRESH_SECRET, 7d expiry
```

---

#### API-AUTH-003: Authentication Routes
**Dependencies:** API-AUTH-002
**Time:** 4 hours
**Description:** Implement all 11 authentication endpoints

**Routes:**
- POST /api/auth/register (#2)
- POST /api/auth/login (#3)
- POST /api/auth/refresh (#4)
- POST /api/auth/logout (#5)
- GET /api/auth/me (#6)
- PATCH /api/auth/profile (#7)
- PATCH /api/auth/password (#8)
- POST /api/auth/forgot-password (#9)
- GET /api/auth/reset-password/:token (#10)
- POST /api/auth/reset-password (#11)

**Tasks:**
1. Create server/services/auth.service.ts with business logic
2. Create server/routes/auth.routes.ts
3. Implement registration with invitation token validation
4. Implement login with bcrypt password verification
5. Implement password reset with email (optional service pattern)
6. Use parseIntParam for all URL parameters
7. Use sendSuccess/sendCreated for responses

**Acceptance Criteria:**
- [ ] All 11 endpoints implemented matching API Contract exactly
- [ ] Registration creates user and consumes invitation
- [ ] Login returns JWT token
- [ ] Profile update validates current user
- [ ] Password change requires current password verification
- [ ] Reset token validation checks expiry
- [ ] parseIntParam used for :token parameter
- [ ] All responses use sendSuccess/sendCreated helpers

**Files:**
- `/server/services/auth.service.ts`
- `/server/routes/auth.routes.ts`
- `/server/lib/password.ts` (bcrypt helpers)

**Skeleton Template (auth.service.ts):**
```typescript
// server/services/auth.service.ts
import { db } from '../db/index.js';
import { users, invitations, passwordResets } from '../db/schema.js';
import { hashPassword, verifyPassword } from '../lib/password.js';
import { generateToken } from '../lib/tokens.js';
import { UnauthorizedError, NotFoundError, ConflictError, BadRequestError } from '../errors/index.js';

interface RegisterInput {
  email: string;
  password: string;
  name: string;
  inviteToken: string;
}

interface LoginInput {
  email: string;
  password: string;
}

// TODO: Implement per API-AUTH-003
// @see API Contract Section 3.1, PRD US-AUTH-001 through US-AUTH-010
// - register(data): Validate invitation, create user, consume token
// - login(credentials): Verify password, generate JWT
// - forgotPassword(email): Create reset token, send email (optional service)
// - resetPassword(token, newPassword): Validate token, update password
// - updateProfile(userId, data): Update name/email
// - changePassword(userId, currentPassword, newPassword): Verify current, update

export async function register(data: RegisterInput) {
  // Use parseIntParam when extracting invitation token
  throw new Error('Not implemented');
}
```

---

#### API-ORG-001: Organization Routes
**Dependencies:** API-AUTH-002, DATA-002
**Time:** 2 hours
**Description:** Implement organization endpoints

**Routes:**
- GET /api/organizations/current (#12)
- PATCH /api/organizations/current (#13)
- GET /api/organizations/members (#14)

**Tasks:**
1. Create server/services/organizations.service.ts
2. Create server/routes/organizations.routes.ts
3. Create server/middleware/role.middleware.ts (requireAdmin)
4. Implement organization-scoped queries
5. Admin-only checks for PATCH endpoint

**Acceptance Criteria:**
- [ ] All 3 endpoints implemented
- [ ] GET /current returns user's organization
- [ ] PATCH /current requires admin role
- [ ] GET /members returns users in organization (scoped by org_id)
- [ ] requireAdmin middleware blocks non-admins

**Files:**
- `/server/services/organizations.service.ts`
- `/server/routes/organizations.routes.ts`
- `/server/middleware/role.middleware.ts`

---

#### API-INV-001: Invitation Routes
**Dependencies:** API-ORG-001
**Time:** 2 hours
**Description:** Implement invitation management endpoints

**Routes:**
- POST /api/invitations (#15)
- GET /api/invitations (#16)
- GET /api/invitations/:invitationId (#17)
- DELETE /api/invitations/:invitationId (#18)

**Tasks:**
1. Create server/services/invitations.service.ts
2. Create server/routes/invitations.routes.ts
3. Generate unique invitation tokens with nanoid
4. Set 7-day expiry on invitations
5. Admin-only for create/delete
6. Use parseIntParam for :invitationId

**Acceptance Criteria:**
- [ ] All 4 endpoints implemented
- [ ] POST creates invitation with unique token
- [ ] GET lists pending invitations (usedAt IS NULL)
- [ ] DELETE cancels invitation (soft delete)
- [ ] parseIntParam used for all :invitationId parameters
- [ ] Admin role required for create/delete

**Files:**
- `/server/services/invitations.service.ts`
- `/server/routes/invitations.routes.ts`

---

#### API-PROJ-001: Project CRUD Routes
**Dependencies:** API-ORG-001
**Time:** 3 hours
**Description:** Implement project management endpoints

**Routes:**
- POST /api/projects (#19)
- GET /api/projects (#20)
- GET /api/projects/:projectId (#21)
- PATCH /api/projects/:projectId (#22)
- DELETE /api/projects/:projectId (#23)

**Tasks:**
1. Create server/services/projects.service.ts
2. Create server/routes/projects.routes.ts
3. Create server/middleware/org-scope.middleware.ts (enforce organization scoping)
4. Implement soft delete (set deletedAt timestamp)
5. Filter out soft-deleted projects in list endpoint
6. Use parseIntParam for :projectId
7. Use parsePaginationParams for GET /projects

**Acceptance Criteria:**
- [ ] All 5 endpoints implemented
- [ ] POST creates project scoped to user's organization
- [ ] GET returns paginated list (excludes soft-deleted)
- [ ] PATCH updates project metadata
- [ ] DELETE soft-deletes (sets deletedAt)
- [ ] parseIntParam used for all :projectId parameters
- [ ] parsePaginationParams used for pagination
- [ ] sendPaginated used for list response
- [ ] Unique name constraint enforced within organization

**Files:**
- `/server/services/projects.service.ts`
- `/server/routes/projects.routes.ts`
- `/server/middleware/org-scope.middleware.ts`

---

#### API-SRC-001: File Source Routes
**Dependencies:** API-PROJ-001
**Time:** 4 hours
**Description:** Implement file upload and source management

**Routes:**
- POST /api/projects/:projectId/sources (#24)
- GET /api/projects/:projectId/sources (#25)
- GET /api/sources/:sourceId (#27)
- PATCH /api/sources/:sourceId (#28)
- DELETE /api/sources/:sourceId (#29)

**Tasks:**
1. Create server/services/sources.service.ts
2. Create server/routes/sources.routes.ts
3. Configure multer for file uploads (100MB max)
4. Parse CSV/XLSX/JSON files
5. Store files in local filesystem (UPLOAD_DIR env var)
6. Auto-detect schema fields
7. Use parseIntParam for :projectId and :sourceId

**Acceptance Criteria:**
- [ ] All 5 endpoints implemented
- [ ] POST accepts multipart/form-data with file upload
- [ ] File size validated (max 100MB)
- [ ] Supported formats: CSV, XLSX, JSON
- [ ] Parsed data cached in sources.cachedData
- [ ] GET list returns sources for project
- [ ] DELETE removes source and file
- [ ] parseIntParam used for all ID parameters

**Files:**
- `/server/services/sources.service.ts`
- `/server/routes/sources.routes.ts`
- `/server/lib/file-parser.ts`

**Skeleton Template (file-parser.ts):**
```typescript
// server/lib/file-parser.ts
import fs from 'fs/promises';
import { parse as parseCsv } from 'csv-parse/sync';

// TODO: Implement per API-SRC-001
// @see Architecture Section 4.2
// - parseCSV(filePath): Parse CSV to JSON array
// - parseXLSX(filePath): Parse Excel to JSON array
// - parseJSON(filePath): Parse and validate JSON
// - detectFields(data): Analyze first 100 rows, return field metadata
```

---

#### API-SRC-002: Teamwork Desk Integration
**Dependencies:** API-SRC-001
**Time:** 3 hours
**Description:** Implement Teamwork Desk API source

**Routes:**
- POST /api/sources/teamwork (#26)
- POST /api/sources/:sourceId/sync (#30)

**Tasks:**
1. Create server/services/teamwork.service.ts
2. Create server/lib/encryption.ts (AES-256-GCM)
3. Encrypt API keys before storing in database
4. Implement Teamwork Desk API client
5. Sync tickets and conversations
6. OPTIONAL SERVICE: If TEAMWORK_API_URL not set, return graceful error

**Acceptance Criteria:**
- [ ] POST /sources/teamwork creates source with encrypted API key
- [ ] API keys encrypted with AES-256-GCM
- [ ] POST /sync fetches data from Teamwork API
- [ ] Data cached in sources.cachedData
- [ ] Graceful degradation if TEAMWORK_API_URL not configured
- [ ] NO bare TODO comments in encryption code

**Files:**
- `/server/services/teamwork.service.ts`
- `/server/lib/encryption.ts`

**Optional Service Pattern:**
```typescript
// If TEAMWORK_API_URL not set:
throw new ServiceUnavailableError('Teamwork Desk integration not configured');
```

---

#### API-SRC-003: Schema and Preview Routes
**Dependencies:** API-SRC-001
**Time:** 3 hours
**Description:** Implement schema mapping and data preview

**Routes:**
- GET /api/sources/:sourceId/preview (#31)
- GET /api/sources/:sourceId/schema (#32)
- PUT /api/sources/:sourceId/schema (#33)

**Tasks:**
1. Create server/services/schema.service.ts
2. Implement schema detection algorithm
3. Create mapping editor (confidence scores)
4. Return first 100 rows for preview
5. Use parseIntParam for :sourceId

**Acceptance Criteria:**
- [ ] All 3 endpoints implemented
- [ ] GET /preview returns first 100 rows from cached data
- [ ] GET /schema returns current mapping configuration
- [ ] PUT /schema updates mapping and sets isConfigured = true
- [ ] Auto-detection assigns confidence scores (high/medium/low)
- [ ] parseIntParam used for :sourceId

**Files:**
- `/server/services/schema.service.ts`

---

#### API-SRC-004: Deidentification Routes
**Dependencies:** API-SRC-003
**Time:** 3 hours
**Description:** Implement PII detection and configuration

**Routes:**
- GET /api/sources/:sourceId/deidentification (#34)
- PUT /api/sources/:sourceId/deidentification (#35)
- POST /api/sources/:sourceId/detect-pii (#57)

**Tasks:**
1. Create server/services/pii.service.ts
2. Create server/utils/pii-patterns.ts with regex patterns
3. Implement PII detection for: email, phone, name, address, SSN, credit card
4. Support masking strategies: replacement, redaction, pseudonymization
5. Create audit log entries for PII detection
6. Use parseIntParam for :sourceId

**Acceptance Criteria:**
- [ ] All 3 endpoints implemented
- [ ] GET returns deidentification config
- [ ] PUT updates config and sets isConfigured = true
- [ ] POST /detect-pii scans sample data and returns detected PII types
- [ ] Regex patterns for all 7 PII types
- [ ] Audit log created for PII detection events
- [ ] parseIntParam used for :sourceId

**Files:**
- `/server/services/pii.service.ts`
- `/server/utils/pii-patterns.ts`
- `/server/utils/audit-log.ts`

**Skeleton Template (pii-patterns.ts):**
```typescript
// server/utils/pii-patterns.ts

// TODO: Implement per API-SRC-004
// @see PRD FEAT-007, Architecture Section 4.2
// - EMAIL_PATTERN: RFC 5322 compliant regex
// - PHONE_PATTERN: US/international formats
// - SSN_PATTERN: XXX-XX-XXXX format
// - CREDIT_CARD_PATTERN: Luhn algorithm validation
// - NAME_PATTERN: Capitalized words heuristic
// - ADDRESS_PATTERN: Street address detection
// - DOB_PATTERN: Date formats
```

---

#### API-PROC-001: Processing Configuration Routes
**Dependencies:** API-SRC-004
**Time:** 2 hours
**Description:** Implement processing pipeline configuration

**Routes:**
- GET /api/projects/:projectId/processing (#36)
- PUT /api/projects/:projectId/processing (#37)

**Tasks:**
1. Create server/services/processing.service.ts
2. Define processing stages: ingest, normalize, deidentify, filter, role_identify, export
3. Store stage configurations in JSONB
4. Validate stage dependencies
5. Use parseIntParam for :projectId

**Acceptance Criteria:**
- [ ] Both endpoints implemented
- [ ] GET returns current processing config
- [ ] PUT updates config with stage configurations
- [ ] Default config created on project creation
- [ ] parseIntParam used for :projectId

**Files:**
- `/server/services/processing.service.ts`

---

#### API-PROC-002: Processing Run Routes
**Dependencies:** API-PROC-001
**Time:** 4 hours
**Description:** Implement processing execution and status tracking

**Routes:**
- POST /api/projects/:projectId/runs (#38)
- GET /api/projects/:projectId/runs (#39)
- GET /api/runs/:runId (#40)
- POST /api/runs/:runId/cancel (#41)
- GET /api/runs/:runId/status (#42)
- GET /api/runs/:runId/logs (#43)

**Tasks:**
1. Extend server/services/processing.service.ts
2. Implement async processing pipeline
3. Track status: pending → running → completed/failed/cancelled
4. Store logs for each stage
5. Background task error handling (Pattern 24)
6. Use parseIntParam for :projectId and :runId
7. Use parsePaginationParams for GET /runs

**Acceptance Criteria:**
- [ ] All 6 endpoints implemented
- [ ] POST starts processing run asynchronously
- [ ] GET /status returns current status and progress
- [ ] GET /logs returns execution logs
- [ ] POST /cancel stops running job
- [ ] parseIntParam used for all ID parameters
- [ ] Background tasks have .catch() handlers
- [ ] No uncaught promise rejections

**Files:**
- `/server/services/processing.service.ts` (extended)

---

#### API-DATASET-001: Dataset Routes
**Dependencies:** API-PROC-002
**Time:** 4 hours
**Description:** Implement dataset output and export

**Routes:**
- GET /api/runs/:runId/dataset (#44)
- GET /api/datasets/:datasetId (#45)
- GET /api/datasets/:datasetId/preview (#46)
- GET /api/datasets/:datasetId/export (#47)
- GET /api/datasets/:datasetId/export/qa (#48)
- GET /api/datasets/:datasetId/export/json (#49)
- GET /api/datasets/:datasetId/stats (#50)

**Tasks:**
1. Create server/services/export.service.ts
2. Implement format transformers:
   - Conversational JSONL (OpenAI format)
   - Q&A pairs JSON
   - Raw structured JSON
3. Generate statistics (record count, field distribution)
4. Stream large exports for memory efficiency
5. Use parseIntParam for :runId and :datasetId
6. Validate export format with Zod enum

**Acceptance Criteria:**
- [ ] All 7 endpoints implemented
- [ ] GET /export defaults to conversational format
- [ ] Query param ?format validated with Zod enum
- [ ] GET /preview returns first 100 records
- [ ] GET /stats returns summary statistics
- [ ] Large exports streamed (not loaded into memory)
- [ ] parseIntParam used for all ID parameters

**Files:**
- `/server/services/export.service.ts`

---

#### API-AUDIT-001: Audit Log Routes
**Dependencies:** API-SRC-004
**Time:** 2 hours
**Description:** Implement audit trail viewing

**Routes:**
- GET /api/audit-logs (#51)
- GET /api/audit-logs/:logId (#52)

**Tasks:**
1. Extend server/utils/audit-log.ts with query functions
2. Create server/routes/audit.routes.ts
3. Implement pagination for log list
4. Admin-only access
5. Use parseIntParam for :logId
6. Use parsePaginationParams for list

**Acceptance Criteria:**
- [ ] Both endpoints implemented
- [ ] GET returns paginated audit logs
- [ ] Scoped to user's organization
- [ ] Admin role required
- [ ] parseIntParam and parsePaginationParams used

**Files:**
- `/server/utils/audit-log.ts` (extended)
- `/server/routes/audit.routes.ts`

---

#### API-USER-001: User Management Routes
**Dependencies:** API-ORG-001
**Time:** 2 hours
**Description:** Implement user viewing and role updates

**Routes:**
- GET /api/users/:userId (#53)
- PATCH /api/users/:userId/role (#54)
- DELETE /api/users/:userId (#55)

**Tasks:**
1. Create server/services/users.service.ts
2. Create server/routes/users.routes.ts
3. Implement role change (admin only)
4. Implement user removal from organization
5. Prevent last admin from being removed/demoted
6. Use parseIntParam for :userId

**Acceptance Criteria:**
- [ ] All 3 endpoints implemented
- [ ] PATCH /role updates user role (admin only)
- [ ] DELETE removes user from organization
- [ ] Validation prevents removing last admin
- [ ] parseIntParam used for :userId

**Files:**
- `/server/services/users.service.ts`
- `/server/routes/users.routes.ts`

---

#### API-VALIDATION-001: Request Validation Middleware
**Dependencies:** All API endpoints
**Time:** 2 hours
**Description:** Add Zod schema validation to all endpoints

**Tasks:**
1. Create server/middleware/validation.middleware.ts
2. Create Zod schemas for each endpoint's request body/query
3. Apply validate() middleware to all routes
4. Return 422 with detailed errors on validation failure

**Acceptance Criteria:**
- [ ] All POST/PATCH/PUT endpoints have Zod validation
- [ ] Query parameters validated (pagination, enums)
- [ ] Validation errors return 422 with field-level details
- [ ] No bare z.unknown() or z.any() schemas (Pattern 25)

**Files:**
- `/server/middleware/validation.middleware.ts`

---

### Phase 4: UI (Frontend Pages)

**Strategy:** Implement all 15 pages in logical order. Each task creates one complete page with routing and data fetching.

#### UI-LAYOUT-001: App Layout and Routing
**Dependencies:** SETUP-005
**Time:** 3 hours
**Description:** Create application shell with routing

**Tasks:**
1. Create client/src/App.tsx with React Router setup
2. Create client/src/components/layout/Header.tsx
3. Create client/src/components/layout/Sidebar.tsx (authenticated users only)
4. Create client/src/lib/api.ts (axios instance with auth interceptor)
5. Create client/src/lib/queryClient.ts (React Query setup)
6. Implement protected route wrapper
7. Configure all 15 routes from UI Specification Section 2

**Acceptance Criteria:**
- [ ] All 15 routes configured in App.tsx
- [ ] Protected routes redirect to /login if unauthenticated
- [ ] Public routes (login, register, forgot-password, reset-password) accessible without auth
- [ ] Header shows user name and logout button when authenticated
- [ ] Sidebar shows navigation for authenticated users
- [ ] ErrorBoundary wraps entire app
- [ ] 401 responses trigger logout and redirect to /login

**Files:**
- `/client/src/App.tsx`
- `/client/src/components/layout/Header.tsx`
- `/client/src/components/layout/Sidebar.tsx`
- `/client/src/lib/api.ts`
- `/client/src/lib/queryClient.ts`

**Skeleton Template (App.tsx):**
```typescript
// client/src/App.tsx
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { QueryClientProvider } from '@tanstack/react-query';
import { queryClient } from './lib/queryClient';
import { ErrorBoundary } from './components/error-boundary';

// TODO: Implement per UI-LAYOUT-001
// @see UI Specification Section 2
// - Import all 15 page components
// - Configure routes with exact paths
// - Wrap protected routes with ProtectedRoute component
// - Add ErrorBoundary wrapper
// - Provide QueryClient context
```

---

#### UI-AUTH-001: Authentication Pages
**Dependencies:** UI-LAYOUT-001, API-AUTH-003
**Time:** 4 hours
**Description:** Create login, register, forgot password, reset password pages

**Pages:**
- LoginPage (/login)
- RegisterPage (/register/:token)
- ForgotPasswordPage (/forgot-password)
- ResetPasswordPage (/reset-password/:token)

**Tasks:**
1. Create client/src/pages/auth/LoginPage.tsx
2. Create client/src/pages/auth/RegisterPage.tsx
3. Create client/src/pages/auth/ForgotPasswordPage.tsx
4. Create client/src/pages/auth/ResetPasswordPage.tsx
5. Create client/src/hooks/useAuth.ts (authentication hook)
6. Implement form validation with react-hook-form + Zod
7. Store JWT token in localStorage
8. Handle registration with invitation token from URL

**Acceptance Criteria:**
- [ ] All 4 pages implemented
- [ ] LoginPage calls POST /api/auth/login
- [ ] RegisterPage calls POST /api/auth/register with invite token from URL
- [ ] ForgotPasswordPage calls POST /api/auth/forgot-password
- [ ] ResetPasswordPage calls POST /api/auth/reset-password
- [ ] Form validation with Zod
- [ ] Error messages displayed
- [ ] Successful login redirects to /
- [ ] Token stored in localStorage

**Files:**
- `/client/src/pages/auth/LoginPage.tsx`
- `/client/src/pages/auth/RegisterPage.tsx`
- `/client/src/pages/auth/ForgotPasswordPage.tsx`
- `/client/src/pages/auth/ResetPasswordPage.tsx`
- `/client/src/hooks/useAuth.ts`

---

#### UI-PROJ-001: Projects Pages
**Dependencies:** UI-AUTH-001, API-PROJ-001
**Time:** 5 hours
**Description:** Create dashboard, projects list, project detail pages

**Pages:**
- DashboardPage (/)
- ProjectsPage (/projects)
- ProjectDetailPage (/projects/:projectId)

**Tasks:**
1. Create client/src/pages/projects/DashboardPage.tsx
2. Create client/src/pages/projects/ProjectsPage.tsx
3. Create client/src/pages/projects/ProjectDetailPage.tsx
4. Create client/src/hooks/useProjects.ts (React Query hooks)
5. Create client/src/components/projects/CreateProjectModal.tsx
6. Create client/src/components/projects/ProjectCard.tsx
7. Implement tabs in ProjectDetailPage: Sources, Processing, Runs

**Acceptance Criteria:**
- [ ] DashboardPage shows recent projects and quick actions
- [ ] ProjectsPage lists all projects with pagination
- [ ] CreateProjectModal calls POST /api/projects
- [ ] ProjectDetailPage loads project with GET /api/projects/:projectId
- [ ] Tabs render correctly (Sources, Processing, Runs)
- [ ] Delete project confirmation dialog
- [ ] useProjects hook manages React Query cache

**Files:**
- `/client/src/pages/projects/DashboardPage.tsx`
- `/client/src/pages/projects/ProjectsPage.tsx`
- `/client/src/pages/projects/ProjectDetailPage.tsx`
- `/client/src/hooks/useProjects.ts`
- `/client/src/components/projects/CreateProjectModal.tsx`
- `/client/src/components/projects/ProjectCard.tsx`

---

#### UI-SRC-001: Source Pages
**Dependencies:** UI-PROJ-001, API-SRC-001
**Time:** 6 hours
**Description:** Create source detail and Teamwork source pages

**Pages:**
- SourceDetailPage (/sources/:sourceId)
- CreateTeamworkSourcePage (/sources/teamwork/new)

**Tasks:**
1. Create client/src/pages/sources/SourceDetailPage.tsx
2. Create client/src/pages/sources/CreateTeamworkSourcePage.tsx
3. Create client/src/components/sources/UploadModal.tsx (file upload)
4. Create client/src/components/sources/SchemaEditor.tsx
5. Create client/src/components/sources/DeidentificationEditor.tsx
6. Create client/src/components/sources/DataPreview.tsx
7. Implement tabs: Preview, Schema, Deidentification

**Acceptance Criteria:**
- [ ] SourceDetailPage loads source with GET /api/sources/:sourceId
- [ ] UploadModal uploads file with POST /api/projects/:projectId/sources
- [ ] CreateTeamworkSourcePage calls POST /api/sources/teamwork
- [ ] SchemaEditor calls PUT /api/sources/:sourceId/schema
- [ ] DeidentificationEditor calls PUT /api/sources/:sourceId/deidentification
- [ ] DataPreview displays first 100 rows
- [ ] File upload shows progress bar
- [ ] Sync button triggers POST /api/sources/:sourceId/sync

**Files:**
- `/client/src/pages/sources/SourceDetailPage.tsx`
- `/client/src/pages/sources/CreateTeamworkSourcePage.tsx`
- `/client/src/components/sources/UploadModal.tsx`
- `/client/src/components/sources/SchemaEditor.tsx`
- `/client/src/components/sources/DeidentificationEditor.tsx`
- `/client/src/components/sources/DataPreview.tsx`

---

#### UI-RUN-001: Processing Run Pages
**Dependencies:** UI-SRC-001, API-PROC-002
**Time:** 4 hours
**Description:** Create run detail page with status polling

**Pages:**
- RunDetailPage (/runs/:runId)

**Tasks:**
1. Create client/src/pages/processing/RunDetailPage.tsx
2. Create client/src/hooks/useRunStatus.ts (polling hook)
3. Create client/src/components/processing/RunStatus.tsx (progress indicator)
4. Create client/src/components/processing/RunLogs.tsx
5. Implement tabs: Status, Logs, Output
6. Poll GET /api/runs/:runId/status every 2 seconds while running

**Acceptance Criteria:**
- [ ] RunDetailPage loads run with GET /api/runs/:runId
- [ ] useRunStatus hook polls status every 2s while status = 'running'
- [ ] Progress indicator shows current stage
- [ ] Logs tab displays execution logs
- [ ] Output tab shows dataset when status = 'completed'
- [ ] Cancel button calls POST /api/runs/:runId/cancel
- [ ] Polling stops when status is terminal (completed/failed/cancelled)

**Files:**
- `/client/src/pages/processing/RunDetailPage.tsx`
- `/client/src/hooks/useRunStatus.ts`
- `/client/src/components/processing/RunStatus.tsx`
- `/client/src/components/processing/RunLogs.tsx`

---

#### UI-DATASET-001: Dataset Pages
**Dependencies:** UI-RUN-001, API-DATASET-001
**Time:** 3 hours
**Description:** Create dataset detail page with export

**Pages:**
- DatasetDetailPage (/datasets/:datasetId)

**Tasks:**
1. Create client/src/pages/datasets/DatasetDetailPage.tsx
2. Create client/src/components/datasets/DatasetPreview.tsx
3. Create client/src/components/datasets/DatasetStats.tsx
4. Create client/src/components/datasets/ExportButton.tsx
5. Implement tabs: Preview, Stats
6. Handle file download for exports

**Acceptance Criteria:**
- [ ] DatasetDetailPage loads dataset with GET /api/datasets/:datasetId
- [ ] Preview tab shows first 100 records
- [ ] Stats tab displays summary statistics
- [ ] ExportButton downloads file in selected format
- [ ] Format selector offers: conversational, qa, json
- [ ] Download triggers browser file save

**Files:**
- `/client/src/pages/datasets/DatasetDetailPage.tsx`
- `/client/src/components/datasets/DatasetPreview.tsx`
- `/client/src/components/datasets/DatasetStats.tsx`
- `/client/src/components/datasets/ExportButton.tsx`

---

#### UI-SETTINGS-001: Settings Pages
**Dependencies:** UI-AUTH-001, API-ORG-001
**Time:** 4 hours
**Description:** Create organization, team, profile settings pages

**Pages:**
- OrganizationSettingsPage (/settings/organization)
- TeamPage (/settings/team)
- ProfilePage (/settings/profile)

**Tasks:**
1. Create client/src/pages/settings/OrganizationSettingsPage.tsx
2. Create client/src/pages/settings/TeamPage.tsx
3. Create client/src/pages/settings/ProfilePage.tsx
4. Create client/src/components/settings/InviteUserModal.tsx
5. Implement role-based access (admin only for org settings)
6. Display members list with role badges

**Acceptance Criteria:**
- [ ] OrganizationSettingsPage calls GET/PATCH /api/organizations/current
- [ ] Admin-only access enforced
- [ ] TeamPage calls GET /api/organizations/members
- [ ] InviteUserModal calls POST /api/invitations
- [ ] ProfilePage calls GET /api/auth/me and PATCH /api/auth/profile
- [ ] Password change form calls PATCH /api/auth/password
- [ ] Role badges show admin/member

**Files:**
- `/client/src/pages/settings/OrganizationSettingsPage.tsx`
- `/client/src/pages/settings/TeamPage.tsx`
- `/client/src/pages/settings/ProfilePage.tsx`
- `/client/src/components/settings/InviteUserModal.tsx`

---

#### UI-AUDIT-001: Audit Logs Page
**Dependencies:** UI-SETTINGS-001, API-AUDIT-001
**Time:** 2 hours
**Description:** Create audit logs viewing page

**Pages:**
- AuditLogsPage (/audit-logs)

**Tasks:**
1. Create client/src/pages/audit/AuditLogsPage.tsx
2. Display paginated audit logs
3. Filter by action type and date range
4. Admin-only access

**Acceptance Criteria:**
- [ ] AuditLogsPage calls GET /api/audit-logs
- [ ] Pagination implemented
- [ ] Admin-only access enforced
- [ ] Logs display timestamp, user, action, details

**Files:**
- `/client/src/pages/audit/AuditLogsPage.tsx`

---

#### UI-ERROR-001: Error Pages
**Dependencies:** UI-LAYOUT-001
**Time:** 1 hour
**Description:** Create 404 and error pages

**Pages:**
- NotFoundPage (*)

**Tasks:**
1. Create client/src/pages/NotFoundPage.tsx
2. Add catch-all route in App.tsx

**Acceptance Criteria:**
- [ ] NotFoundPage shows 404 message
- [ ] Link back to dashboard
- [ ] Catch-all route registered last in App.tsx

**Files:**
- `/client/src/pages/NotFoundPage.tsx`

---

### Phase 5: COMP (Shared Components)

#### COMP-001: Configuration Constants
**Dependencies:** SETUP-003
**Time:** 1 hour
**Description:** Create centralized configuration file

**Tasks:**
1. Create server/lib/config.ts
2. Move all magic numbers to named constants
3. Export configuration object

**Pattern 27 Compliance:**
- NO magic numbers in code
- ALL configuration in config.ts
- Environment variables read once at startup

**Acceptance Criteria:**
- [ ] config.ts exports all configuration values
- [ ] No magic numbers found in codebase
- [ ] All env vars read from config.ts

**Files:**
- `/server/lib/config.ts`

**Example:**
```typescript
// server/lib/config.ts
export const config = {
  port: parseInt(process.env.PORT || '5000', 10),
  jwtSecret: process.env.JWT_SECRET!,
  jwtExpiresIn: '1h',
  bcryptRounds: 10,
  maxFileSize: 100 * 1024 * 1024, // 100MB
  paginationDefaultLimit: 20,
  paginationMaxLimit: 100,
} as const;
```

---

#### COMP-002: Request ID Middleware
**Dependencies:** SETUP-003
**Time:** 1 hour
**Description:** Add request ID tracking

**Tasks:**
1. Create server/middleware/request-id.middleware.ts
2. Generate unique ID for each request
3. Attach to req.id
4. Include in all log statements
5. Include in error responses

**Pattern 26 Compliance:**
- Every request has unique ID
- ID logged with every log statement
- ID returned in error responses

**Acceptance Criteria:**
- [ ] Middleware generates nanoid for each request
- [ ] req.id accessible in all handlers
- [ ] Error responses include requestId in meta

**Files:**
- `/server/middleware/request-id.middleware.ts`

---

#### COMP-003: Rate Limiting Configuration
**Dependencies:** SETUP-003
**Time:** 1 hour
**Description:** Configure express-rate-limit

**Tasks:**
1. Create server/middleware/rate-limit.middleware.ts
2. Configure limits: 100 requests per 15 minutes
3. Trust proxy for rate limiting
4. Return 429 with retry-after header

**Acceptance Criteria:**
- [ ] Rate limit middleware configured
- [ ] 100 requests per 15 minute window
- [ ] Trust proxy enabled
- [ ] Returns RateLimitError when exceeded

**Files:**
- `/server/middleware/rate-limit.middleware.ts`

---

### Phase 6: INTEG (Integration & Verification)

#### INTEG-001: Forbidden Pattern Scan
**Dependencies:** All API and UI tasks
**Time:** 2 hours
**Description:** Run automated scans for forbidden patterns

**Tasks:**
1. Create scripts/forbidden-patterns.sh
2. Scan for 6 forbidden patterns:
   - Direct parseInt() usage (not via parseIntParam)
   - TODO in security-critical code
   - Malformed route paths (missing / before :param)
   - z.unknown() or z.any() in Zod schemas
   - Missing LIMIT on findMany/select queries
   - Magic numbers outside config.ts
3. Generate violation report
4. Fix all violations before deployment

**Acceptance Criteria:**
- [ ] Script scans all .ts files
- [ ] Reports violations with file:line references
- [ ] Zero violations found
- [ ] Script exits with non-zero code if violations found

**Files:**
- `/scripts/forbidden-patterns.sh`

**Script Template:**
```bash
#!/bin/bash
# TODO: Implement per INTEG-001
# - grep for parseInt\( in server/routes/ (exclude validation.ts)
# - grep for TODO in encryption.ts, password.ts, tokens.ts
# - grep for routes without / before :param
# - grep for z.unknown\(\) and z.any\(\) in *.ts
# - grep for findMany without LIMIT
# - grep for hardcoded numbers outside config.ts
```

---

#### INTEG-002: Endpoint Coverage Verification
**Dependencies:** All API tasks
**Time:** 1 hour
**Description:** Verify all 57 endpoints implemented

**Tasks:**
1. Extract all route definitions from server/routes/
2. Compare against API Contract endpoint inventory (Section 1.4)
3. Generate coverage report
4. Verify exact route paths match API Contract

**Acceptance Criteria:**
- [ ] All 57 endpoints present
- [ ] Route paths match API Contract character-for-character
- [ ] HTTP methods match API Contract
- [ ] No extra undocumented endpoints

**Files:**
- `/scripts/verify-endpoints.sh`

---

#### INTEG-003: UI Page Coverage Verification
**Dependencies:** All UI tasks
**Time:** 1 hour
**Description:** Verify all 15 pages implemented

**Tasks:**
1. Extract all route definitions from App.tsx
2. Compare against UI Specification page inventory (Section 2)
3. Verify exact route paths
4. Check for dead links in navigation

**Acceptance Criteria:**
- [ ] All 15 pages present
- [ ] Route paths match UI Specification exactly
- [ ] All navigation links point to valid routes
- [ ] No broken links in Sidebar/Header

**Files:**
- `/scripts/verify-pages.sh`

---

#### INTEG-004: Database Query Audit
**Dependencies:** All API tasks
**Time:** 2 hours
**Description:** Audit all database queries for safety

**Tasks:**
1. Search for all db.select() and db.query() calls
2. Verify every findMany/select has explicit LIMIT (Pattern 23)
3. Verify check-then-act operations use row locking (Pattern 18)
4. Verify all JSONB columns have Zod validation (Pattern 28)

**Acceptance Criteria:**
- [ ] No unbounded queries (all have LIMIT)
- [ ] Race conditions prevented with FOR UPDATE
- [ ] JSONB data validated before storage

**Files:**
- `/scripts/audit-queries.sh`

---

#### INTEG-005: Environment Variable Validation
**Dependencies:** All SETUP tasks
**Time:** 1 hour
**Description:** Test required vs optional env var handling

**Tasks:**
1. Test startup without REQUIRED env vars (should crash)
2. Test startup without OPTIONAL env vars (should degrade gracefully)
3. Verify JWT_SECRET has no fallback (Pattern 22)
4. Document all env vars in README

**Acceptance Criteria:**
- [ ] Missing DATABASE_URL crashes at startup
- [ ] Missing JWT_SECRET crashes at startup
- [ ] Missing TEAMWORK_API_URL shows graceful error on use
- [ ] JWT_SECRET has NO default/fallback value

---

#### INTEG-006: End-to-End User Flow Test
**Dependencies:** All UI tasks
**Time:** 3 hours
**Description:** Manual test of complete user journey

**Test Flow:**
1. Register with invitation link
2. Login with credentials
3. Create project
4. Upload CSV file
5. Configure schema mapping
6. Configure deidentification
7. Run processing pipeline
8. View processing status
9. Export dataset
10. Invite team member
11. Logout

**Acceptance Criteria:**
- [ ] Complete flow works without errors
- [ ] All pages render correctly
- [ ] Data persists correctly
- [ ] File upload handles 100MB files
- [ ] Polling updates run status
- [ ] Export downloads correct format

---

## 5. Development Workflow

### 5.1 Initial Setup

```bash
# 1. Clone repository
git clone <repo-url>
cd foundry

# 2. Install dependencies
npm install

# 3. Set up environment variables
cp .env.example .env
# Edit .env with:
# - DATABASE_URL (from Replit Secrets)
# - JWT_SECRET (generate with: openssl rand -hex 32)
# - ENCRYPTION_KEY (generate with: openssl rand -hex 32)

# 4. Verify Tailwind CSS version matches syntax
# Check client/package.json for tailwindcss version
# Verify client/src/index.css uses correct syntax:
# - v3.x: @tailwind base; @tailwind components; @tailwind utilities;
# - v4.x: @import "tailwindcss";

# 5. Initialize database
cd server
npm run db:push --force   # Replit requires --force flag
npm run db:migrate
npm run db:seed
cd ..

# 6. Start development servers
npm run dev
# Frontend: http://localhost:5173
# Backend: http://localhost:5000
# Health check: http://localhost:5000/api/health
```

### 5.2 Task Execution Order

Follow phases in order:
1. **SETUP (6 tasks)** - Complete all before moving to DATA
2. **DATA (3 tasks)** - Complete all before moving to API
3. **API (15 tasks)** - Can be parallelized by resource
4. **UI (9 tasks)** - Can be parallelized by page group
5. **COMP (3 tasks)** - Complete all before INTEG
6. **INTEG (6 tasks)** - Must be completed sequentially

**Parallelization Strategy:**
- API tasks can run in parallel (one developer per resource)
- UI tasks can run in parallel (one developer per page group)
- SETUP and DATA must be sequential
- INTEG must be sequential

### 5.3 Verification Gates

Run before marking task complete:

**After each API task:**
```bash
# Test endpoint with curl
curl -X GET http://localhost:5000/api/health
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@acme.com","password":"password123"}'

# Check for parseIntParam usage
grep "parseInt(" server/routes/*.ts
# Should return ZERO matches (all should use parseIntParam)

# Check for response helper usage
grep "res.json(" server/routes/*.ts
# Should return ZERO matches (all should use sendSuccess/sendError)
```

**After each UI task:**
```bash
# Check for broken links
npm run lint
npm run type-check

# Verify route exists in App.tsx
grep "/your-route" client/src/App.tsx
```

**Before deployment:**
```bash
# Run all verification gates
npm run lint
npm run type-check
bash scripts/forbidden-patterns.sh
bash scripts/verify-endpoints.sh
bash scripts/verify-pages.sh
bash scripts/audit-queries.sh
```

### 5.4 Deployment Checklist

- [ ] All INTEG tasks pass
- [ ] DATABASE_URL configured in Replit Secrets
- [ ] JWT_SECRET configured (no fallback value)
- [ ] ENCRYPTION_KEY configured
- [ ] Migrations run with --force flag
- [ ] Health check responds at /api/health
- [ ] Frontend builds without errors
- [ ] No console errors in browser
- [ ] Port 5000 accessible
- [ ] Static files served from /dist/public

---

## 6. Starter Code Templates

### 6.1 Service Template

```typescript
// server/services/example.service.ts
import { db } from '../db/index.js';
import { exampleTable } from '../db/schema.js';
import { eq } from 'drizzle-orm';
import { NotFoundError, BadRequestError } from '../errors/index.js';

interface CreateExampleInput {
  name: string;
  description?: string;
}

interface UpdateExampleInput {
  name?: string;
  description?: string;
}

/**
 * Create a new example
 * @see PRD US-EXAMPLE-001, API Contract Section X.X
 */
export async function createExample(
  data: CreateExampleInput,
  organizationId: number
): Promise<any> {
  // TODO: Implement per API-EXAMPLE-001
  // - Validate input
  // - Check duplicates
  // - Insert record
  // - Return created entity
  throw new Error('Not implemented');
}

/**
 * Find example by ID
 * Throws NotFoundError if not found
 */
export async function findExampleById(
  id: number,
  organizationId: number
): Promise<any> {
  // TODO: Implement per API-EXAMPLE-002
  // - Query with organization scoping
  // - Throw NotFoundError if missing
  // - Return entity
  throw new Error('Not implemented');
}

/**
 * Update example
 */
export async function updateExample(
  id: number,
  data: UpdateExampleInput,
  organizationId: number
): Promise<any> {
  // TODO: Implement per API-EXAMPLE-003
  // - Find existing (throws if not found)
  // - Validate update data
  // - Update record
  // - Return updated entity
  throw new Error('Not implemented');
}

/**
 * Delete example
 */
export async function deleteExample(
  id: number,
  organizationId: number
): Promise<void> {
  // TODO: Implement per API-EXAMPLE-004
  // - Verify exists and belongs to org
  // - Delete record (cascade handled by DB)
  throw new Error('Not implemented');
}
```

### 6.2 Route Template

```typescript
// server/routes/example.routes.ts
import { Router } from 'express';
import { asyncHandler } from '../middleware/error-handler.js';
import { parseIntParam, parsePaginationParams } from '../lib/validation.js';
import { sendSuccess, sendCreated, sendPaginated } from '../lib/response.js';
import * as exampleService from '../services/example.service.js';

export const exampleRouter = Router();

/**
 * POST /api/examples - Create example
 * @see API Contract endpoint #X
 */
exampleRouter.post(
  '/',
  asyncHandler(async (req, res) => {
    // TODO: Implement per API-EXAMPLE-001
    // - Validate request body with Zod
    // - Extract organizationId from req.user
    // - Call exampleService.createExample()
    // - Use sendCreated() for response
  })
);

/**
 * GET /api/examples - List examples
 * @see API Contract endpoint #X
 */
exampleRouter.get(
  '/',
  asyncHandler(async (req, res) => {
    // TODO: Implement per API-EXAMPLE-002
    // - Use parsePaginationParams(req.query)
    // - Call exampleService.findAll() with pagination
    // - Use sendPaginated() for response
  })
);

/**
 * GET /api/examples/:id - Get example by ID
 * @see API Contract endpoint #X
 */
exampleRouter.get(
  '/:id',
  asyncHandler(async (req, res) => {
    // TODO: Implement per API-EXAMPLE-003
    // - Use parseIntParam(req.params.id, 'id')
    // - Extract organizationId from req.user
    // - Call exampleService.findById()
    // - Use sendSuccess() for response
  })
);

/**
 * PATCH /api/examples/:id - Update example
 * @see API Contract endpoint #X
 */
exampleRouter.patch(
  '/:id',
  asyncHandler(async (req, res) => {
    // TODO: Implement per API-EXAMPLE-004
    // - Use parseIntParam(req.params.id, 'id')
    // - Validate request body with Zod
    // - Call exampleService.updateExample()
    // - Use sendSuccess() for response
  })
);

/**
 * DELETE /api/examples/:id - Delete example
 * @see API Contract endpoint #X
 */
exampleRouter.delete(
  '/:id',
  asyncHandler(async (req, res) => {
    // TODO: Implement per API-EXAMPLE-005
    // - Use parseIntParam(req.params.id, 'id')
    // - Call exampleService.deleteExample()
    // - Use sendSuccess() with null data
  })
);
```

### 6.3 React Page Template

```typescript
// client/src/pages/example/ExamplePage.tsx
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useParams, useNavigate } from 'react-router-dom';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { toast } from '@/components/ui/use-toast';
import { api } from '@/lib/api';

// TODO: Implement per UI-EXAMPLE-001
// @see UI Specification Section X

export function ExamplePage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();

  // Fetch data
  const { data, isLoading, error } = useQuery({
    queryKey: ['example', id],
    queryFn: async () => {
      const response = await api.get(`/api/examples/${id}`);
      return response.data.data;
    },
  });

  // Mutation example
  const deleteMutation = useMutation({
    mutationFn: async () => {
      await api.delete(`/api/examples/${id}`);
    },
    onSuccess: () => {
      toast({ title: 'Example deleted successfully' });
      queryClient.invalidateQueries({ queryKey: ['examples'] });
      navigate('/examples');
    },
    onError: (error: any) => {
      toast({
        title: 'Error',
        description: error.response?.data?.error?.message || 'Failed to delete',
        variant: 'destructive',
      });
    },
  });

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (error) {
    return <div>Error loading example</div>;
  }

  return (
    <div className="container mx-auto max-w-7xl p-6">
      <Card className="p-6">
        <h1 className="text-2xl font-bold">{data.name}</h1>
        <p className="text-muted-foreground">{data.description}</p>
        
        <div className="mt-6 flex gap-2">
          <Button onClick={() => navigate(`/examples/${id}/edit`)}>
            Edit
          </Button>
          <Button
            variant="destructive"
            onClick={() => deleteMutation.mutate()}
            disabled={deleteMutation.isPending}
          >
            Delete
          </Button>
        </div>
      </Card>
    </div>
  );
}
```

---

## 7. Pre-Completion Verification Gates

Run these checks before marking implementation complete:

### Gate 1: API Endpoint Count Verification

```bash
# Count implemented endpoints
grep -r "router\.(get|post|patch|put|delete)" server/routes/ | wc -l

# Expected: 57 endpoints
```

**Required Actions if Failed:**
- Review API Contract Section 1.4 endpoint inventory
- Identify missing endpoints
- Implement missing routes

---

### Gate 2: UI Page Count Verification

```bash
# Count implemented pages
find client/src/pages -name "*.tsx" | wc -l

# Expected: 15 pages
```

**Required Actions if Failed:**
- Review UI Specification Section 2 page inventory
- Identify missing pages
- Implement missing components

---

### Gate 3: Forbidden Patterns Scan

```bash
bash scripts/forbidden-patterns.sh
```

**Scans for:**
1. Direct parseInt() usage (not via parseIntParam)
2. TODO in security-critical code
3. Malformed route paths
4. z.unknown()/z.any() in Zod schemas
5. Unbounded queries (missing LIMIT)
6. Magic numbers outside config.ts

**Required Actions if Failed:**
- Fix all violations reported
- Re-run scan until zero violations

---

### Gate 4: Route Path Syntax Verification

```bash
# Check for routes without / before :param
grep -r ":[a-zA-Z]" server/routes/ | grep -v "/:"
```

**Expected:** Zero matches

**Required Actions if Failed:**
- Fix all route paths to have / before :param
- Example: `:id` should be `/:id`

---

### Gate 5: HTTP Method Verification

```bash
# Cross-reference HTTP methods with API Contract
# Manual verification required
```

**Check:**
- PATCH vs PUT usage matches API Contract
- DELETE endpoints use correct method
- No undocumented endpoints

---

### Gate 6: Database Query Safety

```bash
bash scripts/audit-queries.sh
```

**Checks:**
1. All findMany/select have LIMIT
2. Check-then-act uses row locking
3. JSONB columns validated with Zod

**Required Actions if Failed:**
- Add LIMIT to unbounded queries
- Add FOR UPDATE to race-prone queries
- Add Zod validation to JSONB insertions

---

## 8. Validation Checklists

### 8.1 Completeness Checklist

- [ ] All 32 PRD user stories have tasks
- [ ] All 57 API endpoints implemented (count matches API Contract)
- [ ] All 15 UI pages implemented (count matches PRD)
- [ ] All auth endpoints implemented (11 total)
- [ ] All tasks have dependencies specified
- [ ] All tasks have acceptance criteria
- [ ] All MANDATORY files have full code
- [ ] Encryption implemented for API keys
- [ ] Optional services use conditional pattern
- [ ] Forbidden pattern scan script included
- [ ] Pre-completion verification gates included
- [ ] Replit configuration verified (--force flags, watch settings)
- [ ] Route paths match API Contract exactly
- [ ] HTTP methods match API Contract

### 8.2 Task Count Summary

| Category | Count | Notes |
|----------|-------|-------|
| SETUP | 6 | Foundation and configuration |
| DATA | 3 | Database schema and seed data |
| API-AUTH | 3 | Authentication and middleware |
| API-ORG | 1 | Organization management |
| API-INV | 1 | Invitation management |
| API-PROJ | 1 | Project CRUD |
| API-SRC | 4 | Source management and integration |
| API-PROC | 2 | Processing configuration and runs |
| API-DATASET | 1 | Dataset and export |
| API-AUDIT | 1 | Audit logs |
| API-USER | 1 | User management |
| API-VALIDATION | 1 | Request validation |
| UI-LAYOUT | 1 | Application shell |
| UI-AUTH | 1 | Authentication pages |
| UI-PROJ | 1 | Project pages |
| UI-SRC | 1 | Source pages |
| UI-RUN | 1 | Processing run pages |
| UI-DATASET | 1 | Dataset pages |
| UI-SETTINGS | 1 | Settings pages |
| UI-AUDIT | 1 | Audit logs page |
| UI-ERROR | 1 | Error pages |
| COMP | 3 | Shared components and utilities |
| INTEG | 6 | Integration testing and verification |
| **TOTAL** | **42** | Total implementation tasks |

### 8.3 Endpoint Verification

API task count (15) covers ALL 57 endpoints:
- Health: 1 endpoint
- Auth: 11 endpoints
- Organizations: 3 endpoints
- Invitations: 4 endpoints
- Projects: 5 endpoints
- Sources: 12 endpoints
- Processing: 6 endpoints
- Runs: 6 endpoints
- Datasets: 7 endpoints
- Audit: 2 endpoints
- Users: 3 endpoints

Total: 57 endpoints ✓

### 8.4 Page Verification

UI task count (9) covers ALL 15 pages:
- Authentication: 4 pages (Login, Register, ForgotPassword, ResetPassword)
- Projects: 3 pages (Dashboard, ProjectsPage, ProjectDetailPage)
- Sources: 2 pages (SourceDetailPage, CreateTeamworkSourcePage)
- Processing: 1 page (RunDetailPage)
- Datasets: 1 page (DatasetDetailPage)
- Settings: 3 pages (OrganizationSettingsPage, TeamPage, ProfilePage)
- Audit: 1 page (AuditLogsPage)
- Error: 1 page (NotFoundPage)

Total: 15 pages ✓ (matches PRD Section 9 exactly)

### 8.5 Audit Prevention Summary

This implementation plan addresses 28 common production issues through mandatory patterns:

**Critical Patterns (10):**
1. Pattern 22: JWT_SECRET fail-fast (no fallback)
2. Pattern 1: parseIntParam for all URL parameters
3. Pattern 2: Response helpers (sendSuccess, sendCreated, sendPaginated)
4. Pattern 3: AppError hierarchy (prevent 500s)
5. Pattern 4: Global error handler
6. Pattern 5: React ErrorBoundary
7. Pattern 6: postgres-js driver (Replit compatibility)
8. Pattern 7: Route path syntax (/ before :param)
9. Pattern 8: HTTP method alignment
10. Pattern 9: Security implementation (no TODO in crypto code)

**High Patterns (11):**
11. Pattern 10: Optional service pattern
12. Pattern 11: Encryption for sensitive data (AES-256-GCM)
13. Pattern 12: Validation with Zod schemas
14. Pattern 13: Admin role checks
15. Pattern 14: Organization scoping
16. Pattern 15: Pagination with parsePaginationParams
17. Pattern 16: Soft delete pattern
18. Pattern 17: File upload validation
19. Pattern 18: Row locking for check-then-act (enhanced with FOR UPDATE)
20. Pattern 19: Background task error handling
21. Pattern 20: Request validation middleware

**Medium Patterns (7):**
22. Pattern 23: Unbounded query LIMIT requirement
23. Pattern 24: Background task error handling (.catch() on promises)
24. Pattern 25: Zod strictness (no z.unknown()/z.any())
25. Pattern 26: Request ID middleware
26. Pattern 27: Configuration constants (no magic numbers)
27. Pattern 28: JSONB validation with Zod
28. Pattern 21: Tailwind CSS version alignment

### 8.6 Document Status

**Status:** COMPLETE

All requirements met:
- ✓ Implementation overview provided
- ✓ Project scaffolding with complete directory structure
- ✓ 6 MANDATORY files with full code
- ✓ Ordered task list (42 tasks across 6 phases)
- ✓ Development workflow documented
- ✓ Starter templates provided
- ✓ Validation checklists included
- ✓ All 57 API endpoints have tasks
- ✓ All 15 UI pages have tasks
- ✓ All Replit configurations specified
- ✓ All 28 audit prevention patterns addressed

---

## Downstream Agent Handoff Brief

### Agent 7: QA & Deployment

**Pre-Deployment Checklist:**
- Run all 6 verification gates (route count, page count, forbidden patterns, link validation, route syntax, HTTP methods)
- Verify all SETUP tasks completed
- Verify Replit configuration (port 5000, --force flags, watch.ignored)
- Verify environment variables (REQUIRED crash at startup, OPTIONAL degrade gracefully)
- Test batch insert performance (>100 records < 1 second)
- Verify validation compliance (test PASS/FAIL cases from API Contract)
- Verify route path syntax (all :params have preceding /)
- Verify HTTP methods match API Contract (especially PATCH vs PUT)
- Verify parseIntParam usage (no direct parseInt in routes)

**NEW v30 Checks:**
- Verify JWT_SECRET has NO fallback (Pattern 22)
- Verify all findMany/select have explicit LIMIT (Pattern 23)
- Verify background tasks have .catch() handlers (Pattern 24)
- Verify no z.unknown()/z.any() in Zod schemas (Pattern 25)
- Verify request ID middleware is present (Pattern 26)
- Verify no magic numbers outside config.ts (Pattern 27)
- Verify JSONB columns use Zod validation (Pattern 28)
- Verify check-then-act operations use row locking (Pattern 18 enhanced)

**Replit Deployment:**
- Port 5000 configured in .replit
- Database migrations run with --force flag
- Static files served from /dist/public
- Health check responds at /api/health

**Audit Prevention (28 patterns):**
- All 6 forbidden pattern checks PASS
- No TODO in security-critical code
- No direct parseInt in routes
- No malformed route paths
- All sensitive data encrypted
- Optional services implement conditional pattern
- JWT_SECRET fail-fast (no fallback)
- All queries have explicit LIMIT
- Background tasks have error handling

---

## ASSUMPTION REGISTER

No assumptions required. All implementation decisions explicitly specified in upstream documents.

**Verification:**
- Database schema from Data Model Document Section 2
- API endpoints from API Contract Document Section 1.4
- UI pages from UI Specification Document Section 2
- Technology stack from Architecture Document Section 2
- Authentication from Constitution Section C
- Deployment from Constitution Section D

All specifications are complete and unambiguous.

---

## Document End
